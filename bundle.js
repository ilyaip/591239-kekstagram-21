(()=>{"use strict";(()=>{const e=(e,t,n)=>{n.responseType="json",n.timeout=1e4,n.addEventListener("load",(()=>{200===n.status?e(n.response):t("Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+n.timeout+"мс")}))};window.backend={upload:(t,n,o)=>{const c=new XMLHttpRequest;e(n,o,c),c.open("POST","https://21.javascript.pages.academy/kekstagram"),c.send(t)},load:(t,n)=>{const o=new XMLHttpRequest;e(t,n,o),o.open("GET","https://21.javascript.pages.academy/kekstagram/data"),o.send()}}})(),window.utils={getRandomElement:e=>e[Math.floor(Math.random()*e.length)]},(()=>{let e;window.debounce=t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("#upload-file"),n=document.querySelector(".img-upload__preview"),o=n.querySelector("img"),c=document.querySelectorAll(".effects__preview"),r=document.querySelector(".img-upload__overlay"),s=document.querySelector("body"),l=document.querySelector(".img-upload__submit"),d=document.querySelector("#upload-cancel"),i=document.querySelector(".scale__control--smaller"),a=document.querySelector(".scale__control--bigger"),m=document.querySelector(".scale__control--value"),u=document.querySelector(".text__hashtags"),v=document.querySelector(".text__description"),y=document.querySelector("#error").content.querySelector(".error"),p=()=>{t.value=""},L=e=>{u!==document.activeElement&&v!==document.activeElement&&"Escape"===e.key&&(e.preventDefault(),r.classList.add("hidden"),s.classList.remove("modal-open"),v.value="",u.value="",p(),document.removeEventListener("keydown",L),l.removeEventListener("click",g))};d.addEventListener("click",(()=>{r.classList.add("hidden"),s.classList.remove("modal-open"),document.removeEventListener("keydown",L),l.removeEventListener("click",g),p(),n.style.filter="none"}));const g=()=>{document.removeEventListener("keydown",L),l.removeEventListener("click",g)};t.addEventListener("change",(()=>{const d=t.files[0],i=d.name.toLowerCase();if(e.some((e=>i.endsWith(e)))){const e=new FileReader;r.classList.remove("hidden"),s.classList.add("modal-open"),l.addEventListener("click",g),document.addEventListener("keydown",L),m.value="100%",n.style.transform="scale(1)",e.addEventListener("load",(()=>{o.src=e.result,c.forEach((t=>{t.style.backgroundImage=`url("${e.result}")`}))})),e.readAsDataURL(d)}else window.comments.renderSuccessMessage(y),p()})),window.dialog={controlSmaller:i,controlBigger:a,controlValue:m,editingForm:r,cleanInput:p}})(),(()=>{const e={chrome:{DEFAULT:"grayscale(1)",MIN_VALUE:"0",MAX_VALUE:"1",UNIT:""},sepia:{DEFAULT:"sepia(1)",MIN_VALUE:"0",MAX_VALUE:"1",UNIT:""},marvin:{DEFAULT:"invert(100%)",MIN_VALUE:"0",MAX_VALUE:"100",UNIT:"%"},phobos:{DEFAULT:"blur(3px)",MIN_VALUE:"0",MAX_VALUE:"3",UNIT:"px"},heat:{DEFAULT:"brightness(3)",MIN_VALUE:"1",MAX_VALUE:"3",UNIT:""},none:{DEFAULT:"none"}};window.dialog.controlValue.value="100%",window.dialog.controlBigger.addEventListener("click",(()=>{(()=>{const e=Number.parseInt(window.dialog.controlValue.value,10)+25,t=e>=100?100:e;window.dialog.controlValue.value=t+"%",l.style.transform=`scale(${t/100})`})()})),window.dialog.controlSmaller.addEventListener("click",(()=>{(()=>{const e=Number.parseInt(window.dialog.controlValue.value,10)-25,t=e<=25?25:e;window.dialog.controlValue.value=t+"%",l.style.transform=`scale(${t/100})`})()}));const t=document.querySelector(".effect-level__pin"),n=document.querySelector(".effect-level"),o=document.querySelector(".effect-level__value"),c=document.querySelector(".img-upload__form"),r=document.querySelector("#effect-none"),s=document.querySelector(".effect-level__depth"),l=document.querySelector(".img-upload__preview"),d=document.querySelector(".effect-level__line");let i;c.addEventListener("change",(function(){r.checked?n.classList.add("hidden"):n.classList.remove("hidden")})),c.addEventListener("change",(n=>{n.target&&n.target.matches('input[type="radio"]')&&(l.style.filter=e[n.target.value].DEFAULT),i=n.target.value,t.style.left="450px",s.style.width="100%"}));const a=t=>Math.round(100*((e[i].MAX_VALUE-e[i].MIN_VALUE)*(t/d.offsetWidth)+e[i].MIN_VALUE))/100;t.addEventListener("mousedown",(n=>{n.preventDefault();const c=n.clientX,r=!1,m=n=>{n.preventDefault(),r=!0;const m=c-n.clientX;c=n.clientX;const u=t.offsetLeft-m;u>0&&u<d.offsetWidth&&(t.style.left=u+"px",s.style.width=100*t.offsetLeft/d.offsetWidth+"%"),(t=>{switch(i){case"chrome":l.style.filter=`grayscale(${a(t)+e[i].UNIT})`;break;case"sepia":l.style.filter=`sepia(${a(t)+e[i].UNIT})`;break;case"marvin":l.style.filter=`invert(${a(t)+e[i].UNIT})`;break;case"phobos":l.style.filter=`blur(${a(t)+e[i].UNIT})`;break;case"heat":l.style.filter=`brightness(${a(t)+e[i].UNIT})`;break;case"none":l.style.filter="none"}})(u),o.value=Number.parseInt(s.style.width,10)},u=e=>{if(e.preventDefault(),document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",u),r){let e=n=>{n.preventDefault(),t.removeEventListener("click",e)};t.addEventListener("click",e)}};document.addEventListener("mousemove",m),document.addEventListener("mouseup",u)}))})(),(()=>{const e=document.querySelector(".text__hashtags"),t=document.querySelector(".text__description"),n=/^#[a-zа-я0-9]{1,20}$/;e.addEventListener("input",(()=>{const t=e.value.trim().toLowerCase().split(/\s+/);t.forEach(((o,c)=>{const{length:r}=o;r<2?e.setCustomValidity("Хэш-тег не может состоять только из #"):r>=20?e.setCustomValidity("Хэш-тег должен содержать не польше 20-ти символов"):n.test(o)?c>=5?e.setCustomValidity("Нельзя указать больше 5 хэш-тегов"):e.setCustomValidity(""):e.setCustomValidity("Хэш-тег должен начинаться с # и не может содержать пробелы, спецсимволы (#, @, $ и т. п.), символы пунктуации (тире, дефис, запятая и т. п.), эмодзи и т. д."),t.filter((e=>e===o)).length>1&&e.setCustomValidity("Хэш-теги не могут быть одинаковыми")}))})),t.addEventListener("input",(()=>{t.value.length>140?t.setCustomValidity("Максимум 140 символов"):t.setCustomValidity("")}))})(),(()=>{const e="Escape";let t=5;const n=document.querySelector(".img-upload__overlay"),o=document.querySelector(".img-upload__form"),c=document.querySelector(".img-upload__preview"),r=document.querySelector("#picture").content.querySelector(".picture"),s=document.querySelector(".pictures"),l=document.querySelector("#success").content.querySelector(".success"),d=document.querySelector("main"),i=document.querySelector("#error").content.querySelector(".error"),a=document.querySelector(".big-picture__img"),m=a.querySelector("img"),u=document.querySelector(".likes-count"),v=document.querySelector(".social__comments"),y=document.querySelector(".social__caption"),p=document.querySelector(".comments-loader"),L=document.querySelector(".comments-count"),g=document.querySelector(".social__comment-count"),h=document.querySelector(".big-picture__cancel"),E=e=>{const t=document.createElement("li");t.classList.add("social__comment");const n=document.createElement("img");t.appendChild(n),n.classList.add("social__picture"),n.src=e.avatar,n.alt=e.name;const o=document.createElement("p");return t.appendChild(o),o.textContent=e.message,o.classList.add("social__text"),t};let _;const f=()=>{for(;v.firstChild;)v.firstChild.remove()};a.addEventListener("click",(()=>{S()}));const w=()=>{U.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),document.removeEventListener("keydown",q)},S=()=>{U.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),document.addEventListener("keydown",q)},q=n=>{n.key===e&&(n.preventDefault(),w(),t=5,f(),p.removeEventListener("click",_))},k=t=>{const n=document.createDocumentFragment(),o=t.cloneNode(!0),c=o.querySelector("button");n.appendChild(o);const r=()=>{o.classList.add("hidden"),c.removeEventListener("click",r),document.removeEventListener("click",s),document.removeEventListener("keydown",l)};c.addEventListener("click",r),d.appendChild(n);const s=e=>{o.querySelector("div").contains(e.target)||(o.classList.add("hidden"),document.removeEventListener("click",s),document.removeEventListener("keydown",l))};document.addEventListener("click",s);const l=t=>{t.key===e&&(t.preventDefault(),o.classList.add("hidden"),document.removeEventListener("keydown",l),document.removeEventListener("click",s))};document.addEventListener("keydown",l)},b=()=>{n.classList.add("hidden"),k(l),c.style.filter="none",window.dialog.cleanInput()},C=()=>{k(i),n.classList.add("hidden"),window.dialog.cleanInput()};o.addEventListener("submit",(e=>{window.backend.upload(new FormData(o),b,C),e.preventDefault()}));const U=document.querySelector(".big-picture");r.addEventListener("click",(()=>{U.classList.remove("hidden")})),window.comments={onError:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},renderPhoto:e=>{const n=document.createDocumentFragment(),o=r.cloneNode(!0);o.querySelector(".picture__img").src=e.url,o.querySelector(".picture__likes").textContent=e.likes,o.querySelector(".picture__comments").textContent=e.comments.length,n.appendChild(o),s.appendChild(n),o.addEventListener("click",(()=>{g.textContent=`${t} из ${e.comments.length} комментариев`,S(),(e=>{m.src=e.url,u.textContent=e.likes,y.textContent=e.description,e.comments.length<t?g.textContent=`${e.comments.length} из ${e.comments.length} комментариев`:L.textContent=e.comments.length})(e);const n=document.createDocumentFragment();e.comments.slice(0,t).forEach((e=>{n.appendChild(E(e))})),v.appendChild(n),e.comments.length<=t?p.classList.add("hidden"):p.classList.remove("hidden"),_=()=>{(e=>{const n=document.createDocumentFragment();e.comments.slice(t,t+5).forEach((e=>{n.appendChild(E(e))})),v.appendChild(n),t+=5,e.comments.length>t?g.textContent=`${t} из ${e.comments.length} комментариев`:(g.textContent=`${e.comments.length} из ${e.comments.length} комментариев`,p.classList.add("hidden"))})(e)},p.addEventListener("click",_);const o=()=>{w(),t=5,p.classList.remove("hidden"),p.removeEventListener("click",_),f(),h.removeEventListener("click",o)};h.addEventListener("click",o)}))},renderSuccessMessage:k}})(),(()=>{const e=document.querySelector(".img-filters"),t=document.querySelector("#filter-default"),n=document.querySelector("#filter-random"),o=document.querySelector("#filter-discussed");let c=[];const r=()=>{document.querySelectorAll(".picture").forEach((e=>{e.remove()}))},s=()=>{n.classList.remove("img-filters__button--active"),t.classList.remove("img-filters__button--active"),o.classList.remove("img-filters__button--active")};t.addEventListener("click",(()=>{r(),s(),window.debounce((()=>{c.forEach((e=>{window.comments.renderPhoto(e)}))})),t.classList.add("img-filters__button--active")})),n.addEventListener("click",(()=>{r(),s();const e=c.slice();window.debounce((()=>{for(let t=0;t<10;t++){const t=Math.floor(Math.random()*e.length);window.comments.renderPhoto(e[t]),e.splice(t,1)}})),n.classList.add("img-filters__button--active")})),o.addEventListener("click",(()=>{r(),s();const e=c.slice();e.sort(((e,t)=>t.comments.length-e.comments.length)),window.debounce((()=>{e.forEach((e=>{window.comments.renderPhoto(e)}))})),o.classList.add("img-filters__button--active")})),window.backend.load((t=>{c=t,e.classList.remove("img-filters--inactive"),(e=>{e.forEach((e=>{window.comments.renderPhoto(e)}))})(c)}),window.comments.onError)})()})();