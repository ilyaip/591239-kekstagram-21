(()=>{"use strict";(()=>{function e(e,t,n){n.responseType="json",n.timeout=1e4,n.addEventListener("load",(function(){200===n.status?e(n.response):t("Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(function(){t("Произошла ошибка соединения")})),n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+"мс")}))}window.backend={upload:function(t,n,o){const c=new XMLHttpRequest;e(n,o,c),c.open("POST","https://21.javascript.pages.academy/kekstagram"),c.send(t)},load:function(t,n){const o=new XMLHttpRequest;e(t,n,o),o.open("GET","https://21.javascript.pages.academy/kekstagram/data"),o.send()}}})(),window.utils={getRandomElement:function(e){return e[Math.floor(Math.random()*e.length)]}},(()=>{let e;window.debounce=function(t){e&&window.clearTimeout(e),e=window.setTimeout(t,500)}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("#upload-file"),n=document.querySelector(".img-upload__preview"),o=n.querySelector("img"),c=document.querySelectorAll(".effects__preview"),i=document.querySelector(".img-upload__overlay"),r=document.querySelector("body"),s=document.querySelector("#upload-cancel"),l=document.querySelector(".scale__control--smaller"),d=document.querySelector(".scale__control--bigger"),u=document.querySelector(".scale__control--value"),a=document.querySelector(".text__hashtags"),m=document.querySelector(".text__description"),f=document.querySelector("#error").content.querySelector(".error");function v(){t.value=""}function y(e){a!==document.activeElement&&m!==document.activeElement&&"Escape"===e.key&&(e.preventDefault(),i.classList.add("hidden"),r.classList.remove("modal-open"),m.value="",a.value="",v())}s.addEventListener("click",(function(){i.classList.add("hidden"),r.classList.remove("modal-open"),document.removeEventListener("keydown",y),v(),n.style.filter="none"})),t.addEventListener("change",(function(){const s=t.files[0],l=s.name.toLowerCase();if(e.some((function(e){return l.endsWith(e)}))){const e=new FileReader;i.classList.remove("hidden"),r.classList.add("modal-open"),document.addEventListener("keydown",y),u.value="100%",n.style.transform="scale(1)",e.addEventListener("load",(function(){o.src=e.result,c.forEach((function(t){t.style.backgroundImage=`url("${e.result}")`}))})),e.readAsDataURL(s)}else window.comments.renderSuccessMessage(f),v()})),window.dialog={controlSmaller:l,controlBigger:d,controlValue:u,editingForm:i,cleanInput:v}})(),(()=>{const e={chrome:{DEFAULT:"grayscale(1)",MIN_VALUE:"0",MAX_VALUE:"1",UNIT:""},sepia:{DEFAULT:"sepia(1)",MIN_VALUE:"0",MAX_VALUE:"1",UNIT:""},marvin:{DEFAULT:"invert(100%)",MIN_VALUE:"0",MAX_VALUE:"100",UNIT:"%"},phobos:{DEFAULT:"blur(3px)",MIN_VALUE:"0",MAX_VALUE:"3",UNIT:"px"},heat:{DEFAULT:"brightness(3)",MIN_VALUE:"1",MAX_VALUE:"3",UNIT:""},none:{DEFAULT:"none"}};window.dialog.controlValue.value="100%",window.dialog.controlBigger.addEventListener("click",(function(){!function(){let e=Number.parseInt(window.dialog.controlValue.value,10)+25,t=e>=100?100:e;window.dialog.controlValue.value=t+"%",s.style.transform=`scale(${t/100})`}()})),window.dialog.controlSmaller.addEventListener("click",(function(){!function(){let e=Number.parseInt(window.dialog.controlValue.value,10)-25,t=e<=25?25:e;window.dialog.controlValue.value=t+"%",s.style.transform=`scale(${t/100})`}()}));const t=document.querySelector(".effect-level__pin"),n=document.querySelector(".effect-level"),o=document.querySelector(".effect-level__value"),c=document.querySelector(".img-upload__form"),i=document.querySelector("#effect-none"),r=document.querySelector(".effect-level__depth"),s=document.querySelector(".img-upload__preview"),l=document.querySelector(".effect-level__line");let d;function u(t){return Math.round(100*((e[d].MAX_VALUE-e[d].MIN_VALUE)*(t/l.offsetWidth)+e[d].MIN_VALUE))/100}c.addEventListener("change",(function(){i.checked?n.classList.add("hidden"):n.classList.remove("hidden")})),c.addEventListener("change",(function(n){n.target&&n.target.matches('input[type="radio"]')&&(s.style.filter=e[n.target.value].DEFAULT),d=n.target.value,t.style.left="450px",r.style.width="100%"})),t.addEventListener("mousedown",(function(n){n.preventDefault();let c=n.clientX,i=!1;function a(n){n.preventDefault(),i=!0;let a=c-n.clientX;c=n.clientX;let m=t.offsetLeft-a;m>0&&m<l.offsetWidth&&(t.style.left=m+"px",r.style.width=100*t.offsetLeft/l.offsetWidth+"%"),function(t){switch(d){case"chrome":s.style.filter=`grayscale(${u(t)+e[d].UNIT})`;break;case"sepia":s.style.filter=`sepia(${u(t)+e[d].UNIT})`;break;case"marvin":s.style.filter=`invert(${u(t)+e[d].UNIT})`;break;case"phobos":s.style.filter=`blur(${u(t)+e[d].UNIT})`;break;case"heat":s.style.filter=`brightness(${u(t)+e[d].UNIT})`;break;case"none":s.style.filter="none"}}(m),o.value=Number.parseInt(r.style.width,10)}document.addEventListener("mousemove",a),document.addEventListener("mouseup",(function e(n){if(n.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",e),i){let e=function(n){n.preventDefault(),t.removeEventListener("click",e)};t.addEventListener("click",e)}}))}))})(),(()=>{const e=document.querySelector(".text__hashtags"),t=document.querySelector(".text__description"),n=/^#[a-zа-я0-9]{1,20}$/;e.addEventListener("input",(function(){let t=e.value.trim().toLowerCase().split(/\s+/);t.forEach((function(o,c){let i=o.length;i<2?e.setCustomValidity("Хэш-тег не может состоять только из #"):i>=20?e.setCustomValidity("Хэш-тег должен содержать не польше 20-ти символов"):n.test(o)?c>=5?e.setCustomValidity("Нельзя указать больше 5 хэш-тегов"):e.setCustomValidity(""):e.setCustomValidity("Хэш-тег должен начинаться с # и не может содержать пробелы, спецсимволы (#, @, $ и т. п.), символы пунктуации (тире, дефис, запятая и т. п.), эмодзи и т. д."),t.filter((function(e){return e===o})).length>1&&e.setCustomValidity("Хэш-теги не могут быть одинаковыми")}))})),t.addEventListener("input",(function(){t.value.length>140?t.setCustomValidity("Максимум 140 символов"):t.setCustomValidity("")}))})(),(()=>{const e="Escape";let t=5;const n=document.querySelector(".img-upload__overlay"),o=document.querySelector(".img-upload__form"),c=document.querySelector(".img-upload__preview"),i=document.querySelector("#picture").content.querySelector(".picture"),r=document.querySelector(".pictures"),s=document.querySelector("#success").content.querySelector(".success"),l=document.querySelector("main"),d=document.querySelector("#error").content.querySelector(".error"),u=document.querySelector(".big-picture__img"),a=u.querySelector("img"),m=document.querySelector(".likes-count"),f=document.querySelector(".social__comments"),v=document.querySelector(".social__caption"),y=document.querySelector(".comments-loader"),p=document.querySelector(".comments-count"),L=document.querySelector(".social__comment-count"),g=document.querySelector(".big-picture__cancel");function h(e){const t=document.createElement("li");t.classList.add("social__comment");const n=document.createElement("img");t.appendChild(n),n.classList.add("social__picture"),n.src=e.avatar,n.alt=e.name;const o=document.createElement("p");return t.appendChild(o),o.textContent=e.message,o.classList.add("social__text"),t}let _;function E(){for(;f.firstChild;)f.firstChild.remove()}function w(){C.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),document.addEventListener("keydown",S)}function S(n){n.key===e&&(n.preventDefault(),C.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),t=5,y.removeEventListener("click",_))}function q(t){const n=document.createDocumentFragment(),o=t.cloneNode(!0);n.appendChild(o),o.querySelector("button").addEventListener("click",(function(){o.classList.add("hidden")})),l.appendChild(n),document.addEventListener("click",(function e(t){o.querySelector("div").contains(t.target)||(o.classList.add("hidden"),document.removeEventListener("click",e))})),document.addEventListener("keydown",(function t(n){n.key===e&&(n.preventDefault(),o.classList.add("hidden"),document.removeEventListener("keydown",t))}))}function k(){n.classList.add("hidden"),q(s),c.style.filter="none",window.dialog.cleanInput()}function b(){q(d),n.classList.add("hidden"),window.dialog.cleanInput()}u.addEventListener("click",(function(){w()})),o.addEventListener("submit",(function(e){window.backend.upload(new FormData(o),k,b),e.preventDefault()}));const C=document.querySelector(".big-picture");i.addEventListener("click",(function(){C.classList.remove("hidden")})),window.comments={onError:function(e){const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},renderPhoto:function(n){const o=document.createDocumentFragment(),c=i.cloneNode(!0);c.querySelector(".picture__img").src=n.url,c.querySelector(".picture__likes").textContent=n.likes,c.querySelector(".picture__comments").textContent=n.comments.length,o.appendChild(c),r.appendChild(o),c.addEventListener("click",(function(){L.textContent=`${t} из ${n.comments.length} комментариев`,w(),function(e){a.src=e.url,m.textContent=e.likes,v.textContent=e.description,e.comments.length<t?L.textContent=`${e.comments.length} из ${e.comments.length} комментариев`:p.textContent=e.comments.length}(n);const o=document.createDocumentFragment();n.comments.slice(0,t).forEach((function(e){o.appendChild(h(e))})),f.appendChild(o),n.comments.length<=t?y.classList.add("hidden"):y.classList.remove("hidden"),_=function(){!function(e){const n=document.createDocumentFragment();e.comments.slice(t,t+5).forEach((function(e){n.appendChild(h(e))})),f.appendChild(n),t+=5,e.comments.length>t?L.textContent=`${t} из ${e.comments.length} комментариев`:(L.textContent=`${e.comments.length} из ${e.comments.length} комментариев`,y.classList.add("hidden"))}(n)},y.addEventListener("click",_),g.addEventListener("click",(function e(){C.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),document.removeEventListener("keydown",S),t=5,y.classList.remove("hidden"),y.removeEventListener("click",_),E(),g.removeEventListener("click",e)})),document.addEventListener("keydown",(function t(n){n.key===e&&(n.preventDefault(),E(),y.removeEventListener("click",_)),document.removeEventListener("keydown",t)}))}))},renderSuccessMessage:q}})(),(()=>{const e=document.querySelector(".img-filters"),t=document.querySelector("#filter-default"),n=document.querySelector("#filter-random"),o=document.querySelector("#filter-discussed");let c=[];function i(){document.querySelectorAll(".picture").forEach((function(e){e.remove()}))}function r(){n.classList.remove("img-filters__button--active"),t.classList.remove("img-filters__button--active"),o.classList.remove("img-filters__button--active")}t.addEventListener("click",(function(){i(),r(),window.debounce((function(){c.forEach((function(e){window.comments.renderPhoto(e)}))})),t.classList.add("img-filters__button--active")})),n.addEventListener("click",(function(){i(),r();const e=c.slice();window.debounce((function(){for(let t=0;t<10;t++){const t=Math.floor(Math.random()*e.length);window.comments.renderPhoto(e[t]),e.splice(t,1)}})),n.classList.add("img-filters__button--active")})),o.addEventListener("click",(function(){i(),r();const e=c.slice();e.sort((function(e,t){return t.comments.length-e.comments.length})),window.debounce((function(){e.forEach((function(e){window.comments.renderPhoto(e)}))})),o.classList.add("img-filters__button--active")})),window.backend.load((function(t){c=t,e.classList.remove("img-filters--inactive"),function(e){e.forEach((function(e){window.comments.renderPhoto(e)}))}(c)}),window.comments.onError)})()})();