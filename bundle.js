(()=>{"use strict";var e,t,n,o,c,r,i,s,l,d,a,u,m,v,f,y,L;(()=>{function e(e,t,n){n.responseType="json",n.timeout=1e4,n.addEventListener("load",(function(){200===n.status?e(n.response):t("Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(function(){t("Произошла ошибка соединения")})),n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+"мс")}))}window.backend={upload:function(t,n,o){var c=new XMLHttpRequest;e(n,o,c),c.open("POST","https://21.javascript.pages.academy/kekstagram"),c.send(t)},load:function(t,n){var o=new XMLHttpRequest;e(t,n,o),o.open("GET","https://21.javascript.pages.academy/kekstagram/data"),o.send()}}})(),window.utils={getRandomElement:function(e){return e[Math.floor(Math.random()*e.length)]}},window.debounce=function(t){e&&window.clearTimeout(e),e=window.setTimeout(t,500)},t=["gif","jpg","jpeg","png"],n=document.querySelector("#upload-file"),o=document.querySelector(".img-upload__preview"),c=o.querySelector("img"),r=document.querySelectorAll(".effects__preview"),i=document.querySelector(".img-upload__overlay"),s=document.querySelector("body"),l=document.querySelector("#upload-cancel"),d=document.querySelector(".scale__control--smaller"),a=document.querySelector(".scale__control--bigger"),u=document.querySelector(".scale__control--value"),m=document.querySelector(".text__hashtags"),v=document.querySelector(".text__description"),f=document.querySelector("#error").content.querySelector(".error"),y=function(){n.value=""},L=function(e){m!==document.activeElement&&v!==document.activeElement&&"Escape"===e.key&&(e.preventDefault(),i.classList.add("hidden"),s.classList.remove("modal-open"),v.value="",m.value="",y())},l.addEventListener("click",(function(){i.classList.add("hidden"),s.classList.remove("modal-open"),document.removeEventListener("keydown",L),y(),o.style.filter="none"})),n.addEventListener("change",(function(){var e=n.files[0],l=e.name.toLowerCase();if(t.some((function(e){return l.endsWith(e)}))){var d=new FileReader;i.classList.remove("hidden"),s.classList.add("modal-open"),document.addEventListener("keydown",L),u.value="100%",o.style.transform="scale(1)",d.addEventListener("load",(function(){c.src=d.result,r.forEach((function(e){e.style.backgroundImage=`url("${d.result}")`}))})),d.readAsDataURL(e)}else window.comments.renderSuccessMessage(f),y()})),window.dialog={controlSmaller:d,controlBigger:a,controlValue:u,editingForm:i},(()=>{var e={chrome:{DEFAULT:"grayscale(1)",MIN_VALUE:"0",MAX_VALUE:"1",UNIT:""},sepia:{DEFAULT:"sepia(1)",MIN_VALUE:"0",MAX_VALUE:"1",UNIT:""},marvin:{DEFAULT:"invert(100%)",MIN_VALUE:"0",MAX_VALUE:"100",UNIT:"%"},phobos:{DEFAULT:"blur(3px)",MIN_VALUE:"0",MAX_VALUE:"3",UNIT:"px"},heat:{DEFAULT:"brightness(3)",MIN_VALUE:"1",MAX_VALUE:"3",UNIT:""},none:{DEFAULT:"none"}};window.dialog.controlValue.value="100%",window.dialog.controlBigger.addEventListener("click",(function(){var e,t;t=(e=Number.parseInt(window.dialog.controlValue.value,10)+25)>=100?100:e,window.dialog.controlValue.value=t+"%",l.style.transform=`scale(${t/100})`})),window.dialog.controlSmaller.addEventListener("click",(function(){var e,t;t=(e=Number.parseInt(window.dialog.controlValue.value,10)-25)<=25?25:e,window.dialog.controlValue.value=t+"%",l.style.transform=`scale(${t/100})`}));var t,n=document.querySelector(".effect-level__pin"),o=document.querySelector(".effect-level"),c=document.querySelector(".effect-level__value"),r=document.querySelector(".img-upload__form"),i=document.querySelector("#effect-none"),s=document.querySelector(".effect-level__depth"),l=document.querySelector(".img-upload__preview"),d=document.querySelector(".effect-level__line");function a(n){return Math.round(100*((e[t].MAX_VALUE-e[t].MIN_VALUE)*(n/d.offsetWidth)+e[t].MIN_VALUE))/100}r.addEventListener("change",(function(){i.checked?o.classList.add("hidden"):o.classList.remove("hidden")})),r.addEventListener("change",(function(o){o.target&&o.target.matches('input[type="radio"]')&&(l.style.filter=e[o.target.value].DEFAULT),t=o.target.value,n.style.left="450px",s.style.width="100%"})),n.addEventListener("mousedown",(function(o){o.preventDefault();var r=o.clientX,i=!1,u=function(o){o.preventDefault(),i=!0;var u=r-o.clientX;r=o.clientX;var m=n.offsetLeft-u;m>0&&m<d.offsetWidth&&(n.style.left=m+"px",s.style.width=100*n.offsetLeft/d.offsetWidth+"%"),function(n){switch(t){case"chrome":l.style.filter=`grayscale(${a(n)+e[t].UNIT})`;break;case"sepia":l.style.filter=`sepia(${a(n)+e[t].UNIT})`;break;case"marvin":l.style.filter=`invert(${a(n)+e[t].UNIT})`;break;case"phobos":l.style.filter=`blur(${a(n)+e[t].UNIT})`;break;case"heat":l.style.filter=`brightness(${a(n)+e[t].UNIT})`;break;case"none":l.style.filter="none"}}(m),c.value=Number.parseInt(s.style.width,10)},m=function(e){if(e.preventDefault(),document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",m),i){var t=function(e){e.preventDefault(),n.removeEventListener("click",t)};n.addEventListener("click",t)}};document.addEventListener("mousemove",u),document.addEventListener("mouseup",m)}))})(),(()=>{var e=document.querySelector(".text__hashtags"),t=document.querySelector(".text__description"),n=/^#[a-zа-я0-9]{1,20}$/;e.addEventListener("input",(function(){for(var t=e.value.trim().toLowerCase().split(/\s+/),o=0;o<t.length;o++){var c=t[o].length;c<2?e.setCustomValidity("Хэш-тег не может состоять только из #"):c>=20?e.setCustomValidity("Хэш-тег должен содержать не польше 20-ти символов"):n.test(t[o])?o>=5?e.setCustomValidity("Нельзя указать больше 5 хэш-тегов"):e.setCustomValidity(""):e.setCustomValidity("Хэш-тег должен начинаться с # и не может содержать пробелы, спецсимволы (#, @, $ и т. п.), символы пунктуации (тире, дефис, запятая и т. п.), эмодзи и т. д."),t.filter((function(e){return e===t[o]})).length>1&&e.setCustomValidity("Хэш-теги не могут быть одинаковыми")}})),t.addEventListener("input",(function(){t.value.length>140?t.setCustomValidity("Максимум 140 символов"):t.setCustomValidity("")}))})(),(()=>{var e,t=5,n="Escape",o=document.querySelector(".img-upload__overlay"),c=document.querySelector(".img-upload__form"),r=document.querySelector(".img-upload__preview"),i=document.querySelector("#picture").content.querySelector(".picture"),s=document.querySelector(".pictures"),l=document.querySelector("#success").content.querySelector(".success"),d=document.querySelector("main"),a=document.querySelector("#error").content.querySelector(".error"),u=document.querySelector(".big-picture__img"),m=u.querySelector("img"),v=document.querySelector(".likes-count"),f=document.querySelector(".social__comments"),y=document.querySelector(".social__caption"),L=document.querySelector(".comments-loader"),p=document.querySelector(".comments-count"),g=document.querySelector(".social__comment-count"),h=document.querySelector(".big-picture__cancel");function _(e){var t=document.createElement("li");f.appendChild(t),t.classList.add("social__comment");var o=document.createElement("img");t.appendChild(o),o.classList.add("social__picture"),o.src=e.avatar,o.alt=e.name;var c=document.createElement("p");t.appendChild(c),c.textContent=e.message,c.classList.add("social__text"),h.addEventListener("click",(function(){t.remove()})),document.addEventListener("keydown",(function(e){e.key===n&&(e.preventDefault(),t.remove())}))}function E(){b.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),document.addEventListener("keydown",w)}function w(o){o.key===n&&(o.preventDefault(),b.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),t=5,L.removeEventListener("click",e))}u.addEventListener("click",(function(){E()}));var S=function(e){var t=e.cloneNode(!0);d.appendChild(t),t.querySelector("button").addEventListener("click",(function(){t.classList.add("hidden")})),document.addEventListener("click",(function e(n){t.querySelector("div").contains(n.target)||(t.classList.add("hidden"),document.removeEventListener("click",e))}));var o=function(e){e.key===n&&(e.preventDefault(),t.classList.add("hidden"),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o)},q=function(){o.classList.add("hidden"),S(l),r.style.filter="none"},k=function(){S(a)};c.addEventListener("submit",(function(e){window.backend.upload(new FormData(c),q,k),e.preventDefault()}));var b=document.querySelector(".big-picture");i.addEventListener("click",(function(){b.classList.remove("hidden")})),window.comments={errorHandler:function(e){var t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},renderPhoto:function(n){var o=i.cloneNode(!0);o.querySelector(".picture__img").src=n.url,o.querySelector(".picture__likes").textContent=n.likes,o.querySelector(".picture__comments").textContent=n.comments.length,s.appendChild(o),o.addEventListener("click",(function(){if(g.textContent=`${t} из ${n.comments.length} комментариев`,E(),function(e){m.src=e.url,v.textContent=e.likes,y.textContent=e.description,e.comments.length<t?g.textContent=`${e.comments.length} из ${e.comments.length} комментариев`:p.textContent=e.comments.length}(n),n.comments.length<t)n.comments.forEach((function(e){_(e)}));else for(var o=0;o<t;o++)_(n.comments[o]);n.comments.length<=t?L.classList.add("hidden"):L.classList.remove("hidden"),e=function(){!function(e){if(e.comments.length>t)if(e.comments.length-t>5){t+=5,g.textContent=`${t} из ${e.comments.length} комментариев`;for(var n=t-5;n<t;n++)_(e.comments[n])}else{g.textContent=`${e.comments.length} из ${e.comments.length} комментариев`;for(var o=t;o<e.comments.length;o++)_(e.comments[o]);L.classList.add("hidden")}else L.classList.add("hidden")}(n)},L.addEventListener("click",e),h.addEventListener("click",(function(){b.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),document.removeEventListener("keydown",w),t=5,L.classList.remove("hidden"),L.removeEventListener("click",e)}))}))},renderSuccessMessage:S}})(),(()=>{var e=document.querySelector(".img-filters"),t=document.querySelector("#filter-default"),n=document.querySelector("#filter-random"),o=document.querySelector("#filter-discussed"),c=[];function r(){for(var e=document.querySelectorAll(".picture"),t=0;t<e.length;t++)e[t].remove()}function i(){n.classList.remove("img-filters__button--active"),t.classList.remove("img-filters__button--active"),o.classList.remove("img-filters__button--active")}t.addEventListener("click",(function(){r(),i(),window.debounce((function(){c.forEach((function(e){window.comments.renderPhoto(e)}))})),t.classList.add("img-filters__button--active")})),n.addEventListener("click",(function(){r(),i();var e=[];e=e.concat(c),window.debounce((function(){for(var t=0;t<10;t++){const t=Math.floor(Math.random()*e.length);window.comments.renderPhoto(e[t]),e.splice(t,1)}})),n.classList.add("img-filters__button--active")})),o.addEventListener("click",(function(){r(),i();var e=[];(e=e.concat(c)).sort((function(e,t){return t.comments.length-e.comments.length})),window.debounce((function(){e.forEach((function(e){window.comments.renderPhoto(e)}))})),o.classList.add("img-filters__button--active")})),window.backend.load((function(t){c=t,e.classList.remove("img-filters--inactive"),function(e){e.forEach((function(e){window.comments.renderPhoto(e)}))}(c)}),window.comments.errorHandler)})()})();